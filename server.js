/**
 * LINE Bot Webhook - è‡ªå‹•å›žè¦†å…¨é›†ï¼ˆå¯æ•´åŒ…æ›¿æ›ï¼Œå«ã€Œæ•æ„Ÿå•é¡Œã€å°Žæµä¸­é†«å¸«ï¼‰
 * npm i express @line/bot-sdk
 *
 * ENV:
 *  - CHANNEL_ACCESS_TOKEN
 *  - CHANNEL_SECRET
 *  - PORT (optional)
 */

"use strict";

const express = require("express");
const line = require("@line/bot-sdk");

const { CHANNEL_ACCESS_TOKEN, CHANNEL_SECRET, PORT = 3000 } = process.env;
if (!CHANNEL_ACCESS_TOKEN || !CHANNEL_SECRET) {
  console.error("ç¼ºå°‘ç’°å¢ƒè®Šæ•¸ï¼šCHANNEL_ACCESS_TOKEN æˆ– CHANNEL_SECRET");
  process.exit(1);
}

const config = {
  channelAccessToken: CHANNEL_ACCESS_TOKEN,
  channelSecret: CHANNEL_SECRET,
};

const app = express();
const client = new line.Client(config);

/** =========================
 * A) åº—å®¶/ç”¢å“è¨­å®šï¼ˆå·²ä¾ä½ æä¾›è³‡æ–™å¡«å¥½ï¼‰
 * ========================= */
const STORE = {
  brandName: "ä»™åŠ å‘³ãƒ»é¾œé¹¿",
  address: "å°åŒ—å¸‚è¬è¯å€è¥¿æ˜Œè¡— 52 è™Ÿ",
  phoneDisplay: "(02) 2381-2990", // é¡¯ç¤ºç”¨
  website: "https://ts15825868.github.io/TaiShing/index.html",

  specs: {
    gel: { name: "é¾œé¹¿è†", size: 100, unit: "g/ç½" },
    drink: { name: "é¾œé¹¿é£²", size: 180, unit: "cc/åŒ…" },
    soup: { name: "é¾œé¹¿æ¹¯å¡Š", size: "ä¸€æ–¤ï¼åŠæ–¤ï¼4å…©", unit: "" },
    antler: { name: "é¹¿èŒ¸ç²‰", size: 75, unit: "g/ç½" },
  },

  pricingNote:
    "åƒ¹æ ¼æœƒä¾è³¼è²·æ•¸é‡ï¼çµ„åˆèˆ‡å‡ºè²¨æ–¹å¼ä¸åŒã€‚éº»ç…©å›žè¦†ã€Œå“é …ï¼‹æ•¸é‡ï¼‹å¯„é€åœ°å€ã€ï¼Œæˆ‘é€™é‚Šç«‹å³å ±åƒ¹çµ¦æ‚¨ðŸ˜Š",

  testingNote:
    "ç›®å‰æˆ‘å€‘å¯æä¾›å…«å¤§ç‡Ÿé¤Šç´ ç­‰åŸºæœ¬è³‡è¨Šï¼ˆä¾æ‰¹æ¬¡/åŒ…è£æ¨™ç¤ºç‚ºæº–ï¼‰ã€‚å¦‚éœ€æ›´è©³ç´°è³‡æ–™ï¼Œæ­¡è¿Žç•™è¨€ï¼Œæˆ‘å€‘æ•´ç†å¾Œå›žè¦†æ‚¨ã€‚",

  paymentNote:
    "ä»˜æ¬¾æ–¹å¼å¯ä¾è¨‚å–®å®‰æŽ’ï¼ˆå¦‚ï¼šè½‰å¸³ç­‰ï¼‰ã€‚è«‹å›žè¦†ã€Œå“é …ï¼‹æ•¸é‡ï¼‹å¯„é€åœ°å€ã€ï¼Œæˆ‘æœƒä¸€ä½µæä¾›ä»˜æ¬¾èˆ‡é‹é€æ–¹å¼ã€‚",

  shippingNote:
    "å¯å®‰æŽ’å®…é…/è¶…å•†ç­‰æ–¹å¼ï¼ˆä¾åœ°å€èˆ‡å“é …è€Œå®šï¼‰ã€‚è«‹å›žè¦†ã€Œå¯„é€ç¸£å¸‚ï¼‹å“é …ï¼‹æ•¸é‡ã€ï¼Œæˆ‘æœƒæä¾›é‹è²»èˆ‡åˆ°è²¨æ™‚é–“é ä¼°ã€‚",

  // æ•æ„Ÿå•é¡Œå°Žæµï¼ˆä½ æä¾›çš„å…§å®¹ï¼‰
  doctorLineId: "@changwuchi",
  doctorLink: "https://lin.ee/1MK4NR9",
};

/** =========================
 * B) å›žè¦†æ–‡æ¡ˆï¼ˆç¹é«”ä¸­æ–‡ï¼Œé¿å…é†«ç™‚å®£ç¨±ï¼‰
 * ========================= */
const TEXT = {
  welcome: [
    "æ‚¨å¥½ï¼Œæ­¡è¿Žæ‚¨ ðŸ˜Š",
    `é€™è£¡æ˜¯ã€${STORE.brandName}ã€‘å®˜æ–¹å¸³è™Ÿ`,
    "",
    "æ‚¨å¯ä»¥è¼¸å…¥é—œéµå­—å¿«é€Ÿå–å¾—è³‡è¨ŠðŸ‘‡",
    "1ï¸âƒ£ æœ‰ä»€éº¼ç”¢å“",
    "2ï¸âƒ£ åƒ¹æ ¼ï¼å”®åƒ¹",
    "3ï¸âƒ£ å®¹é‡ï¼è¦æ ¼",
    "4ï¸âƒ£ é¾œé¹¿è†æ€Žéº¼åƒ",
    "5ï¸âƒ£ é¾œé¹¿é£²æ€Žéº¼å–",
    "6ï¸âƒ£ æ€Žéº¼è²·ï¼é‹é€ï¼ä»˜æ¬¾",
    "7ï¸âƒ£ é–€å¸‚è³‡è¨Š",
    "",
    "ä¹Ÿå¯ä»¥ç›´æŽ¥ç•™è¨€æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å€‘å°‡ç”±å°ˆäººå›žè¦†ã€‚",
  ].join("\n"),

  products: [
    "ç›®å‰ä¸»è¦ç”¢å“å¦‚ä¸‹ðŸ‘‡",
    "",
    "â–ªï¸ é¾œé¹¿è†",
    "â–ªï¸ é¾œé¹¿é£²",
    "â–ªï¸ é¾œé¹¿æ¹¯å¡Š",
    "â–ªï¸ é¹¿èŒ¸ç²‰",
    "",
    "æƒ³çœ‹è¦æ ¼è«‹è¼¸å…¥ã€Œå®¹é‡ã€æˆ–ã€Œè¦æ ¼ã€",
    "æƒ³çœ‹é£Ÿç”¨æ–¹å¼è«‹è¼¸å…¥ï¼š",
    "ã€Œé¾œé¹¿è†æ€Žéº¼åƒã€ï¼ã€Œé¾œé¹¿é£²æ€Žéº¼å–ã€",
  ].join("\n"),

  pricing: [
    "é—œæ–¼åƒ¹æ ¼ï¼å”®åƒ¹ï¼š",
    STORE.pricingNote,
    "",
    "å»ºè­°æ‚¨å›žè¦†ï¼š",
    "â‘  å“é …ï¼ˆé¾œé¹¿è†/é¾œé¹¿é£²/æ¹¯å¡Š/é¹¿èŒ¸ç²‰ï¼‰",
    "â‘¡ æ•¸é‡",
    "â‘¢ å¯„é€åœ°å€ï¼ˆç¸£å¸‚ï¼‰",
    "æˆ‘å°±èƒ½ä¸€æ¬¡å ±ï¼šå•†å“ï¼‹é‹è²»ï¼‹åˆ°è²¨æ–¹å¼ðŸ˜Š",
  ].join("\n"),

  specs: [
    "ã€å®¹é‡ï¼è¦æ ¼ã€‘",
    "",
    `â–ªï¸ ${STORE.specs.gel.name}ï¼šæ¯ç½ ${STORE.specs.gel.size} ${STORE.specs.gel.unit}`,
    `â–ªï¸ ${STORE.specs.drink.name}ï¼šæ¯åŒ… ${STORE.specs.drink.size} ${STORE.specs.drink.unit}`,
    `â–ªï¸ ${STORE.specs.soup.name}ï¼š${STORE.specs.soup.size}`,
    `â–ªï¸ ${STORE.specs.antler.name}ï¼šæ¯ç½ ${STORE.specs.antler.size} ${STORE.specs.antler.unit}`,
    "",
    "è‹¥æ‚¨è¦æ­é…è³¼è²·ï¼Œå›žè¦†ã€Œå“é …ï¼‹æ•¸é‡ï¼‹å¯„é€ç¸£å¸‚ã€ï¼Œæˆ‘å¯ä»¥ç›´æŽ¥å¹«æ‚¨æ•´ç†åˆé©æ–¹æ¡ˆã€‚",
  ].join("\n"),

  gelHow: [
    "ã€é¾œé¹¿è† é£Ÿç”¨æ–¹å¼ã€‘",
    "",
    "â–ªï¸ å»ºè­°æ—©ä¸Šæˆ–ç©ºè…¹å‰å¾Œé£Ÿç”¨",
    "â–ªï¸ ä¸€å¤©ä¸€æ¬¡ï¼Œä¸€å°åŒ™ï¼ˆåˆæ¬¡å¯å…ˆåŠåŒ™ï¼‰",
    "â–ªï¸ å¯ç”¨ç†±æ°´åŒ–é–‹å¾Œæ­é…æº«æ°´ï¼Œæˆ–ç›´æŽ¥é£Ÿç”¨",
    "â–ªï¸ é£Ÿç”¨æœŸé–“é¿å…å†°é£²",
    "",
    "è‹¥æ‚¨å±¬æ–¼å­•å“ºï¼æ…¢æ€§ç—…ç”¨è—¥ä¸­ï¼ç‰¹æ®Šé«”è³ªç­‰æƒ…æ³ï¼Œå»ºè­°å…ˆè«®è©¢åˆä½œä¸­é†«å¸«äº†è§£å¾Œå†é£Ÿç”¨ã€‚",
    "ï¼ˆå¯è¼¸å…¥ï¼šå­•å©¦ï¼å“ºä¹³ï¼ç”¨è—¥ï¼æ…¢æ€§ç—… ç­‰ï¼Œæˆ‘æœƒæä¾›è«®è©¢æ–¹å¼ï¼‰",
  ].join("\n"),

  drinkHow: [
    "ã€é¾œé¹¿é£² é£²ç”¨æ–¹å¼ã€‘",
    "",
    "â–ªï¸ æ¯æ—¥ä¸€åŒ…",
    "â–ªï¸ å¯éš”æ°´åŠ ç†±æˆ–æº«ç†±é£²ç”¨",
    "â–ªï¸ å»ºè­°æ—©ä¸Šæˆ–ç™½å¤©é£²ç”¨",
    "â–ªï¸ é£²ç”¨æœŸé–“é¿å…å†°é£²",
    "",
    "è‹¥æ‚¨å±¬æ–¼å­•å“ºï¼æ…¢æ€§ç—…ç”¨è—¥ä¸­ï¼ç‰¹æ®Šé«”è³ªç­‰æƒ…æ³ï¼Œå»ºè­°å…ˆè«®è©¢åˆä½œä¸­é†«å¸«äº†è§£å¾Œå†é£²ç”¨ã€‚",
    "ï¼ˆå¯è¼¸å…¥ï¼šå­•å©¦ï¼å“ºä¹³ï¼ç”¨è—¥ï¼æ…¢æ€§ç—… ç­‰ï¼Œæˆ‘æœƒæä¾›è«®è©¢æ–¹å¼ï¼‰",
  ].join("\n"),

  soupHow: [
    "ã€é¾œé¹¿æ¹¯å¡Š ä½¿ç”¨æ–¹å¼ã€‘",
    "",
    "â–ªï¸ ä¾å€‹äººå£å‘³åŠ å…¥é©é‡æ°´ç…®æ»¾",
    "â–ªï¸ å¯æ­é…è‚‰é¡ž/é£Ÿæä¸€èµ·ç‡‰ç…®",
    "â–ªï¸ å»ºè­°ç†±é£²ç†±é£Ÿï¼Œé¿å…å†°å†·æ­é…",
  ].join("\n"),

  antlerHow: [
    "ã€é¹¿èŒ¸ç²‰ é£Ÿç”¨å»ºè­°ã€‘",
    "",
    "â–ªï¸ å¯ä¾å€‹äººç¿’æ…£æ­é…æº«æ°´/é£²å“",
    "â–ªï¸ å»ºè­°ç™½å¤©é£Ÿç”¨ç‚ºä¸»",
    "â–ªï¸ é¿å…å†°é£²æ­é…",
    "",
    "è‹¥æ‚¨å±¬æ–¼å­•å“ºï¼æ…¢æ€§ç—…ç”¨è—¥ä¸­ï¼ç‰¹æ®Šé«”è³ªç­‰æƒ…æ³ï¼Œå»ºè­°å…ˆè«®è©¢åˆä½œä¸­é†«å¸«äº†è§£å¾Œå†é£Ÿç”¨ã€‚",
    "ï¼ˆå¯è¼¸å…¥ï¼šå­•å©¦ï¼å“ºä¹³ï¼ç”¨è—¥ï¼æ…¢æ€§ç—… ç­‰ï¼Œæˆ‘æœƒæä¾›è«®è©¢æ–¹å¼ï¼‰",
  ].join("\n"),

  ingredients: [
    "ã€æˆåˆ†ï¼åŽŸæ–™ã€‘",
    "",
    "è‹¥æ‚¨æƒ³äº†è§£ç‰¹å®šå“é …çš„æˆåˆ†ï¼Œè«‹å›žè¦†ï¼š",
    "ã€Œæˆåˆ† é¾œé¹¿è†ã€æˆ–ã€Œæˆåˆ† é¾œé¹¿é£²ã€",
    "",
    "æˆ‘æœƒæŠŠå°æ‡‰å“é …çš„æˆåˆ†è³‡è¨Šæ•´ç†çµ¦æ‚¨ã€‚",
  ].join("\n"),

  ingredientsGel: [
    "ã€é¾œé¹¿è†ï½œæˆåˆ†ã€‘",
    "è«‹ä»¥å¯¦éš›åŒ…è£æ¨™ç¤ºç‚ºæº–ã€‚",
    "è‹¥æ‚¨éœ€è¦æˆ‘æä¾›æ–‡å­—ç‰ˆæˆåˆ†æ¸…å–®ï¼Œè«‹å›žè¦†ã€Œé¾œé¹¿è† æˆåˆ†æ–‡å­—ã€ï¼Œæˆ‘å¯æ›¿æ‚¨æ•´ç†æˆå¯è²¼æ¨™æ ¼å¼ã€‚",
  ].join("\n"),

  ingredientsDrink: [
    "ã€é¾œé¹¿é£²ï½œæˆåˆ†ã€‘",
    "è«‹ä»¥å¯¦éš›åŒ…è£æ¨™ç¤ºç‚ºæº–ã€‚",
    "è‹¥æ‚¨éœ€è¦æˆ‘æä¾›æ–‡å­—ç‰ˆæˆåˆ†æ¸…å–®ï¼Œè«‹å›žè¦†ã€Œé¾œé¹¿é£² æˆåˆ†æ–‡å­—ã€ï¼Œæˆ‘å¯æ›¿æ‚¨æ•´ç†æˆå¯è²¼æ¨™æ ¼å¼ã€‚",
  ].join("\n"),

  storage: [
    "ã€ä¿å­˜æ–¹å¼ï¼ä¿å­˜æœŸé™ã€‘",
    "",
    "â–ªï¸ è«‹ä¾åŒ…è£æ¨™ç¤ºä¹‹ä¿å­˜æ–¹å¼ç‚ºæº–",
    "â–ªï¸ é¿å…é«˜æº«ã€æ½®æ¿•ã€æ—¥ç…§ç›´å°„",
    "â–ªï¸ é–‹å°å¾Œå»ºè­°ç›¡å¿«é£Ÿç”¨/å†·è—ï¼ˆä¾å“é …æ¨™ç¤ºï¼‰",
    "",
    "è‹¥æ‚¨å‘Šè¨´æˆ‘æ˜¯å“ªå€‹å“é …ï¼Œæˆ‘å¯ä»¥å›žè¦†æ›´ç²¾æº–çš„ä¿å­˜æ–¹å¼ã€‚",
  ].join("\n"),

  testing: [
    "ã€æª¢é©—ï¼å ±å‘Šã€‘",
    "",
    STORE.testingNote,
    "",
    "è‹¥æ‚¨éœ€è¦æŒ‡å®šå“é …æˆ–æŒ‡å®šæ‰¹æ¬¡/æ—¥æœŸï¼Œè«‹ç•™è¨€ï¼Œæˆ‘å€‘æœƒå”åŠ©æä¾›å¯æä¾›çš„è³‡æ–™ã€‚",
  ].join("\n"),

  whoSuitable: [
    "ã€é©åˆå°è±¡ï¼æ³¨æ„äº‹é …ã€‘",
    "",
    "æ¯å€‹äººé«”è³ªã€ä½œæ¯èˆ‡é£²é£Ÿç¿’æ…£ä¸åŒï¼Œå»ºè­°ä»¥ã€Œè£œé¤Š/æ—¥å¸¸ä¿å¥ã€è§’åº¦è©•ä¼°ã€‚",
    "",
    "è‹¥æ‚¨å±¬æ–¼ä»¥ä¸‹æƒ…æ³ï¼ˆå­•å“º/æ…¢æ€§ç—…/è¦å¾‹ç”¨è—¥/æ‰‹è¡“å‰å¾Œ/å…’ç«¥ç­‰ï¼‰ï¼Œ",
    "ç‚ºé¿å…èª¤è§£ï¼Œå»ºè­°å…ˆç”±åˆä½œä¸­é†«å¸«ä¸€å°ä¸€äº†è§£å¾Œå†è©•ä¼°æ˜¯å¦é©åˆã€‚",
    "",
    "å¯ç›´æŽ¥è¼¸å…¥ï¼šå­•å©¦ï¼å“ºä¹³ï¼ç”¨è—¥ï¼æ…¢æ€§ç—…ï¼æ‰‹è¡“ï¼å°å­© ç­‰ï¼Œæˆ‘æœƒæä¾›è«®è©¢æ–¹å¼ã€‚",
  ].join("\n"),

  howToBuy: [
    "ã€æ€Žéº¼è²·ï¼ä¸‹å–®æµç¨‹ã€‘",
    "",
    "è«‹ç›´æŽ¥å›žè¦†ï¼š",
    "â‘  å“é …",
    "â‘¡ æ•¸é‡",
    "â‘¢ å¯„é€åœ°å€ï¼ˆç¸£å¸‚ï¼‰",
    "",
    "æˆ‘æœƒå›žè¦†ï¼š",
    "â–ªï¸ å•†å“è³‡è¨Š/è¦æ ¼",
    "â–ªï¸ åƒ¹æ ¼ï¼ˆä¾æ•¸é‡/çµ„åˆï¼‰",
    "â–ªï¸ é‹é€æ–¹å¼èˆ‡é‹è²»",
    "â–ªï¸ ä»˜æ¬¾æ–¹å¼",
  ].join("\n"),

  payment: ["ã€ä»˜æ¬¾æ–¹å¼ã€‘", "", STORE.paymentNote].join("\n"),

  shipping: ["ã€é‹é€ï¼é‹è²»ï¼åˆ°è²¨ã€‘", "", STORE.shippingNote].join("\n"),

  storeInfo: [
    "ã€é–€å¸‚è³‡è¨Šã€‘",
    "",
    `åº—åï¼š${STORE.brandName}`,
    `åœ°å€ï¼š${STORE.address}`,
    `é›»è©±ï¼š${STORE.phoneDisplay}`,
    `å®˜ç¶²ï¼š${STORE.website}`,
  ].join("\n"),

  website: ["å®˜ç¶²é€£çµåœ¨é€™è£¡ðŸ‘‡", STORE.website].join("\n"),

  // âœ… æ•æ„Ÿå•é¡Œçµ±ä¸€å°Žæµï¼ˆä½ æä¾›çš„å®Œæ•´å›žè¦†ï¼‰
  sensitive: [
    "é€™éƒ¨åˆ†æœƒå› æ¯å€‹äººçš„èº«é«”ç‹€æ³ä¸åŒï¼Œ",
    "ç‚ºäº†è®“æ‚¨å¾—åˆ°æ›´æº–ç¢ºçš„èªªæ˜Žèˆ‡å»ºè­°ï¼Œ",
    "å»ºè­°å…ˆç”±åˆä½œçš„ä¸­é†«å¸«äº†è§£æ‚¨çš„æƒ…æ³ðŸ™‚",
    "",
    "âœ” å°ˆäººä¸€å°ä¸€èªªæ˜Ž",
    "âœ” å¯è©¢å•é©ä¸é©åˆé£Ÿç”¨",
    "âœ” å¯è©¢å•å€‹äººç‹€æ³èˆ‡ç–‘å•",
    "",
    `âž¤ Line IDï¼š${STORE.doctorLineId}`,
    "âž¤ ç« ç„¡å¿Œä¸­é†«å¸«è«®è©¢é€£çµï¼š",
    STORE.doctorLink,
  ].join("\n"),

  fallback: [
    "ä¸å¥½æ„æ€ï¼Œæˆ‘å¯èƒ½æ²’æœ‰å®Œå…¨ç†è§£æ‚¨çš„æ„æ€ ðŸ˜Š",
    "",
    "æ‚¨å¯ä»¥è©¦è©¦è¼¸å…¥ðŸ‘‡",
    "â–ªï¸ æœ‰ä»€éº¼ç”¢å“",
    "â–ªï¸ åƒ¹æ ¼",
    "â–ªï¸ å®¹é‡",
    "â–ªï¸ é¾œé¹¿è†æ€Žéº¼åƒ",
    "â–ªï¸ é¾œé¹¿é£²æ€Žéº¼å–",
    "â–ªï¸ æ€Žéº¼è²·",
    "â–ªï¸ é–€å¸‚è³‡è¨Š",
    "",
    "æˆ–ç›´æŽ¥ç•™è¨€æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å€‘å°‡ç”±å°ˆäººå›žè¦†æ‚¨ã€‚",
  ].join("\n"),
};

/** =========================
 * C) é—œéµå­—è¦å‰‡ï¼ˆåŒç¾©è©ž + æ¨¡ç³Šå‘½ä¸­ï¼‰
 * ========================= */

function normalizeText(s) {
  return String(s || "")
    .replace(/\u3000/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function matchAny(t, patterns) {
  return patterns.some((p) =>
    p instanceof RegExp ? p.test(t) : String(t).includes(p)
  );
}

const INTENT = {
  welcome: ["ä½ å¥½", "å“ˆå›‰", "å—¨", "å¹«åŠ©", "é–‹å§‹", "menu", "é¸å–®", "è«®è©¢", "lineè«®è©¢", "å®¢æœ"],
  products: ["æœ‰ä»€éº¼ç”¢å“", "ç”¢å“", "å“é …", "å•†å“", "æœ‰å“ªäº›", "ç›®éŒ„", "ä»‹ç´¹"],
  pricing: ["åƒ¹æ ¼", "å”®åƒ¹", "å¤šå°‘éŒ¢", "åƒ¹éŒ¢", "å ±åƒ¹", "æ‰¹ç™¼", "æŠ˜æ‰£", "å„ªæƒ ", "ä¸€ç½å¤šå°‘", "ä¸€ç›’å¤šå°‘"],
  specs: ["å®¹é‡", "è¦æ ¼", "å¹¾å…‹", "å¹¾g", "å¹¾å…¬å…‹", "å¹¾cc", "å¹¾æ¯«å‡", "ml", "åŒ…è£", "ä¸€ç›’å¹¾åŒ…", "ä¸€ç½å¹¾g", "å¤šå¤§", "å¤šå°‘é‡"],
  gelHow: ["é¾œé¹¿è†æ€Žéº¼åƒ", "é¾œé¹¿è†åƒæ³•", "è†æ€Žéº¼åƒ", "é¾œé¹¿è†"],
  drinkHow: ["é¾œé¹¿é£²æ€Žéº¼å–", "é¾œé¹¿é£²å–æ³•", "é£²æ€Žéº¼å–", "é¾œé¹¿é£²"],
  soupHow: ["æ¹¯å¡Šæ€Žéº¼ç”¨", "æ¹¯å¡Š", "æ€Žéº¼ç…®", "æ€Žéº¼ç…®æ¹¯", "æ–™ç†æ–¹å¼"],
  antlerHow: ["é¹¿èŒ¸ç²‰æ€Žéº¼åƒ", "ç²‰æ€Žéº¼åƒ", "é¹¿èŒ¸ç²‰", "é¹¿èŒ¸"],
  ingredients: ["æˆåˆ†", "åŽŸæ–™", "å…§å®¹ç‰©", "é…æ–¹", "æœ‰åŠ ä»€éº¼"],
  storage: ["ä¿å­˜", "ä¿å­˜æœŸé™", "æœ‰æ•ˆæœŸé™", "æœŸé™", "æ”¾å¤šä¹…", "è¦å†°å—Ž", "è¦å†·è—å—Ž", "å¸¸æº«", "é–‹å°"],
  testing: ["æª¢é©—", "å ±å‘Š", "æª¢æ¸¬", "åˆæ ¼", "å®‰å…¨", "å…«å¤§ç‡Ÿé¤Šç´ "],
  whoSuitable: ["é©åˆ", "ä¸é©åˆ", "èª°å¯ä»¥", "èª°ä¸èƒ½"],
  howToBuy: ["æ€Žéº¼è²·", "ä¸‹å–®", "è³¼è²·", "è¨‚è³¼", "è¦æ€Žéº¼è¨‚", "æ€Žéº¼ä¸‹è¨‚", "è³¼è²·æ–¹å¼", "æ€Žéº¼ä¸‹å–®"],
  payment: ["ä»˜æ¬¾", "è½‰å¸³", "è²¨åˆ°ä»˜æ¬¾", "åˆ·å¡", "åŒ¯æ¬¾"],
  shipping: ["é‹é€", "å¯„é€", "é‹è²»", "åˆ°è²¨", "å¹¾å¤©åˆ°", "å®…é…", "è¶…å•†", "åº—åˆ°åº—"],
  storeInfo: ["é–€å¸‚", "åº—é¢", "åœ°å€", "åœ¨å“ª", "ä½ç½®", "ç‡Ÿæ¥­", "é›»è©±", "æ€Žéº¼åŽ»", "åœ°é»ž"],
  website: ["å®˜ç¶²", "ç¶²ç«™", "ç¶²å€", "ç¶²é "],

  // âœ… æ•æ„Ÿå•é¡Œï¼šåªè¦å‘½ä¸­å°±å°Žåˆ°ä¸­é†«å¸«
  sensitive: [
    "å­•å©¦","æ‡·å­•","å‚™å­•","å“ºä¹³","é¤µæ¯ä¹³",
    "å°å­©","å…’ç«¥","æœªæˆå¹´",
    "æ…¢æ€§ç—…","ä¸‰é«˜","é«˜è¡€å£“","è¡€å£“","ç³–å°¿ç—…","è¡€ç³–","é«˜è¡€ç³–","ç—›é¢¨",
    "è…Ž","è…Žè‡Ÿ","æ´—è…Ž","è‚","è‚è‡Ÿ",
    "å¿ƒè‡Ÿ","å¿ƒè¡€ç®¡","ä¸­é¢¨",
    "ç™Œ","ç™Œç—‡","è…«ç˜¤","åŒ–ç™‚","æ”¾ç™‚",
    "æ‰‹è¡“","è¡“å¾Œ",
    "ç”¨è—¥","æ­£åœ¨åƒè—¥","æŠ—å‡è¡€","é˜¿æ–¯åŒ¹éˆ","warfarin",
    "éŽæ•","é«”è³ª","å‰¯ä½œç”¨",
    "èƒ½ä¸èƒ½åƒ","å¯ä»¥åƒå—Ž","é©ä¸é©åˆ","æœƒä¸æœƒ","å±éšªå—Ž",
  ],
};

function pickReply(userText) {
  const raw = normalizeText(userText);
  const t = raw.toLowerCase();

  // âœ… æ•æ„Ÿå¥åº·ç‹€æ³ â†’ å„ªå…ˆå°Žæµä¸­é†«å¸«ï¼ˆé¿å…é¢¨éšªï¼‰
  if (matchAny(raw, INTENT.sensitive) || matchAny(t, INTENT.sensitive)) {
    return TEXT.sensitive;
  }

  // ã€Œæˆåˆ† + å“é …ã€ï¼šæˆåˆ† é¾œé¹¿è† / æˆåˆ†é¾œé¹¿é£²
  if (raw.includes("æˆåˆ†")) {
    if (raw.includes("é¾œé¹¿è†") || raw.includes("è†")) return TEXT.ingredientsGel;
    if (raw.includes("é¾œé¹¿é£²") || raw.includes("é£²")) return TEXT.ingredientsDrink;
    return TEXT.ingredients;
  }

  if (matchAny(t, INTENT.welcome)) return TEXT.welcome;
  if (matchAny(t, INTENT.storeInfo)) return TEXT.storeInfo;
  if (matchAny(t, INTENT.website)) return TEXT.website;

  if (matchAny(t, INTENT.products)) return TEXT.products;
  if (matchAny(t, INTENT.pricing)) return TEXT.pricing;
  if (matchAny(t, INTENT.specs)) return TEXT.specs;

  if (matchAny(t, INTENT.gelHow)) return TEXT.gelHow;
  if (matchAny(t, INTENT.drinkHow)) return TEXT.drinkHow;
  if (matchAny(t, INTENT.soupHow)) return TEXT.soupHow;
  if (matchAny(t, INTENT.antlerHow)) return TEXT.antlerHow;

  if (matchAny(t, INTENT.ingredients)) return TEXT.ingredients;
  if (matchAny(t, INTENT.storage)) return TEXT.storage;
  if (matchAny(t, INTENT.testing)) return TEXT.testing;
  if (matchAny(t, INTENT.whoSuitable)) return TEXT.whoSuitable;

  if (matchAny(t, INTENT.howToBuy)) return TEXT.howToBuy;
  if (matchAny(t, INTENT.payment)) return TEXT.payment;
  if (matchAny(t, INTENT.shipping)) return TEXT.shipping;

  return TEXT.fallback;
}

/** =========================
 * D) Webhook
 * ========================= */
app.get("/", (req, res) => res.status(200).send("OK"));

app.post("/webhook", line.middleware(config), async (req, res) => {
  try {
    const events = req.body.events || [];
    await Promise.all(events.map(handleEvent));
    res.status(200).end();
  } catch (err) {
    console.error("Webhook error:", err);
    res.status(500).end();
  }
});

async function handleEvent(event) {
  if (event.type !== "message") return null;
  if (!event.message || event.message.type !== "text") return null;

  const userText = event.message.text || "";
  const replyText = pickReply(userText);

  return client.replyMessage(event.replyToken, {
    type: "text",
    text: replyText,
  });
}

app.listen(PORT, () => {
  console.log(`LINE bot webhook listening on port ${PORT}`);
});
